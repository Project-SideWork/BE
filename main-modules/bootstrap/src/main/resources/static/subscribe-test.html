<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SSE í†µí•© í…ŒìŠ¤íŠ¸</title>
</head>
<body>

<h2>SSE 2ê°œ ë™ì‹œ ì—°ê²° í…ŒìŠ¤íŠ¸</h2>

<button onclick="startConnections()">ì—°ê²° ì‹œì‘</button>

<pre id="result"></pre>

<script>
    const token = "eyJhbGciOiJIUzI1NiJ9.eyJjYXRlZ29yeSI6ImFjY2VzcyIsImVtYWlsIjoiZ2xpdHQxMTIxQG5hdmVyLmNvbSIsImlhdCI6MTc3MTYzMDk3MCwiZXhwIjoxNzcxNjMyNzcwfQ.ZaR4gqAOkjWNogogjX2m4tA6ThHijy5sBYtkOwwLgqQ";
    const chatRoomId = 1;
    const myEmail = "glitt1121@naver.com";

    function log(msg) {
        document.getElementById("result").textContent += "\n" + msg;
    }

    // ğŸ”¥ ê³µí†µ SSE ì—°ê²° í•¨ìˆ˜
    async function connectSSE(url, name, handler) {

        const response = await fetch(url, {
            method: "GET",
            headers: {
                "Authorization": "Bearer " + token,
                "Accept": "text/event-stream"
            }
        });

        if (!response.ok) {
            log(name + " ì—°ê²° ì‹¤íŒ¨: " + response.status);
            return;
        }

        log(name + " ì—°ê²° ì„±ê³µ");

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");

        let buffer = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) {
                log(name + " ì—°ê²° ì¢…ë£Œ");
                break;
            }

            buffer += decoder.decode(value, { stream: true });

            const parts = buffer.split("\n\n");
            buffer = parts.pop();

            for (let part of parts) {
                handler(part);
            }
        }
    }

    // ğŸ”¥ ì±„íŒ… ì´ë²¤íŠ¸ ì²˜ë¦¬
    function handleChatEvent(raw) {
        const lines = raw.split("\n");
        let data = "";

        for (let line of lines) {
            if (line.startsWith("data:")) {
                data += line.replace("data:", "").trim();
            }
        }

        if (!data) return;

        try {
            const parsed = JSON.parse(data);

            log("ğŸ’¬ ì±„íŒ…: " + parsed.message);

        } catch (e) {
            log("ì±„íŒ… íŒŒì‹± ì‹¤íŒ¨: " + data);
        }
    }

    // ğŸ”¥ ì‚¬ìš©ì ì•Œë¦¼ ì´ë²¤íŠ¸ ì²˜ë¦¬
    function handleUserEvent(raw) {
        const lines = raw.split("\n");
        let data = "";

        for (let line of lines) {
            if (line.startsWith("data:")) {
                data += line.replace("data:", "").trim();
            }
        }

        if (!data) return;

        try {
            const parsed = JSON.parse(data);

            log("ğŸ”” ì‚¬ìš©ì ì•Œë¦¼: " + parsed.message);

        } catch (e) {
            log("ì•Œë¦¼ íŒŒì‹± ì‹¤íŒ¨: " + data);
        }
    }

    // ğŸ”¥ ë‘ ê°œ ë‹¤ ì—°ê²°
    function startConnections() {

        connectSSE(
            "http://localhost:8080/api/v1/notifications/subscribe",
            "USER SSE",
            handleUserEvent
        );

        connectSSE(
            "http://localhost:8080/api/v1/chats/subscribe/" + chatRoomId,
            "CHAT SSE",
            handleChatEvent
        );
    }

</script>

</body>
</html>