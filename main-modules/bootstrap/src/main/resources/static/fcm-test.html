<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FCM 토큰 발급 테스트</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.25rem; }
    button { padding: 0.5rem 1rem; margin: 0.25rem 0.25rem 0.25rem 0; cursor: pointer; }
    pre { background: #f5f5f5; padding: 1rem; overflow-x: auto; font-size: 0.75rem; word-break: break-all; }
    .status { margin: 0.5rem 0; color: #666; font-size: 0.9rem; }
    .error { color: #c00; }
    .success { color: #080; }
  </style>
</head>
<body>
  <h1>FCM 토큰 발급 테스트</h1>
  <p class="status">아래 "토큰 발급" 버튼을 누르면 알림 권한 요청 후 FCM 토큰을 발급합니다.</p>
  <button id="btnGetToken">토큰 발급</button>
  <button id="btnRegister">서버에 토큰 등록</button>
  <p class="status" id="status"></p>
  <label>발급된 토큰:</label>
  <pre id="tokenArea">(버튼을 눌러 주세요)</pre>

  <script type="module">
    // Firebase Web 설정: Firebase 콘솔 > 프로젝트 설정 > 일반 > 내 앱 > 웹 앱
    // VAPID 키: 프로젝트 설정 > Cloud Messaging > 웹 푸시 인증서 > "키 쌍" 생성 후
    //           표시되는 공개 키(Public Key) 전체를 아래 vapidKey에 넣으세요. (applicationServerKey와 다름)
    const firebaseConfig = {
      apiKey: "AIzaSyDwHKbyXY2YqiV1dwClKArYz8NqOLPJH3o",
      authDomain: "fcmtest-2eeed.firebaseapp.com",
      projectId: "fcmtest-2eeed",
      storageBucket: "fcmtest-2eeed.firebasestorage.app",
      messagingSenderId: "903263294981",
      appId: "1:903263294981:web:c7c45f4fdd279a17deee6c"
    };
    const vapidKey = 'BMZob3RD84dgKDOLfGpl2HeHt9dXAVP8Ri4sGOKcH0awCUF37IerFKWmvBy7gg-EKa5N5xBMC85g6FnLBkxjQdM'; // 위 설명대로 Cloud Messaging > 웹 푸시 인증서에서 공개 키 복사

    const statusEl = document.getElementById('status');
    const tokenArea = document.getElementById('tokenArea');
    let currentToken = null;

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (isError ? 'error' : 'success');
    }

    async function getToken() {
      try {
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js');
        const { getMessaging, getToken: getFcmToken, isSupported } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js');

        if (!await isSupported()) {
          setStatus('이 브라우저는 FCM을 지원하지 않습니다.', true);
          return;
        }

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          setStatus('알림 권한이 거부되었습니다.', true);
          return;
        }

        if (!vapidKey || vapidKey === 'YOUR_VAPID_KEY' || vapidKey.length < 80) {
          setStatus('VAPID 키가 없거나 잘못되었습니다. Firebase 콘솔 > 프로젝트 설정 > Cloud Messaging > 웹 푸시 인증서에서 "키 쌍" 생성 후 공개 키를 fcm-test.html의 vapidKey에 넣어주세요.', true);
          return;
        }

        const token = await getFcmToken(messaging, { vapidKey });
        if (token) {
          currentToken = token;
          tokenArea.textContent = token;
          setStatus('토큰이 발급되었습니다. "서버에 토큰 등록"으로 저장하세요.');
        } else {
          setStatus('토큰 발급에 실패했습니다. VAPID 키를 확인하세요.', true);
        }

        // 포그라운드에서 수신 시 알림 표시 (탭이 열려 있을 때)
        const { onMessage } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js');
        onMessage(messaging, (payload) => {
          const title = payload.notification?.title ?? payload.data?.title ?? '알림';
          const options = {
            body: payload.notification?.body ?? payload.data?.body ?? ''
          };
          if (Notification.permission === 'granted') {
            new Notification(title, options);
          }
          setStatus('포그라운드 수신: ' + title);
        });
      } catch (e) {
        console.error(e);
        setStatus('오류: ' + e.message, true);
        tokenArea.textContent = '(오류: ' + e.message + ')';
      }
    }

    async function registerToken() {
      if (!currentToken) {
        setStatus('먼저 "토큰 발급"을 눌러 주세요.', true);
        return;
      }
      try {
        const res = await fetch('/api/v1/notifications/fcm-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: currentToken, pushAgreed: true })
        });
        if (res.ok) {
          setStatus('서버에 토큰이 등록되었습니다.');
        } else {
          const text = await res.text();
          setStatus('등록 실패: ' + res.status + ' ' + text, true);
        }
      } catch (e) {
        setStatus('등록 오류: ' + e.message, true);
      }
    }

    document.getElementById('btnGetToken').addEventListener('click', getToken);
    document.getElementById('btnRegister').addEventListener('click', registerToken);
  </script>
</body>
</html>
